---
import fs from 'node:fs';
import path from 'node:path';

interface Props {
  number: number;
  title: string;
  prompt: string;
  description?: string;
  category: 'women' | 'men' | 'kids';
  imagePath?: string;
}

const { number, title, prompt, description, category, imagePath: explicitImagePath } = Astro.props;

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
const possibleExtensions = ['.jpg', '.jpeg', '.png', '.webp'];
let foundImagePath = null;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –≤ public/images/results/
const publicDir = path.join(process.cwd(), 'public');
const resultsDir = '/images/results';
const baseFilename = `prompt-${number}`;

for (const ext of possibleExtensions) {
  const relativePath = path.join(resultsDir, baseFilename + ext);
  const fullPath = path.join(publicDir, relativePath);
  
  if (fs.existsSync(fullPath)) {
    foundImagePath = relativePath;
    break;
  }
}

// –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —è–≤–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ
const finalImagePath = foundImagePath || explicitImagePath;
---

<div class="prompt-card group">
  <div class="prompt-header">
    <div class="prompt-number">#{number}</div>
    <h3 class="prompt-title">{title}</h3>
    <button class="copy-button" data-prompt={prompt}>
      üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
    </button>
  </div>
  
  {description && (
    <p class="prompt-description text-muted-foreground mb-3 text-sm">{description}</p>
  )}
  
  <div class="prompt-layout">
    <div class="prompt-content">
      <div class="prompt-text-container relative group/container">
        <pre class="prompt-text transition-all duration-500 ease-in-out overflow-hidden" style="max-height: 180px;">{prompt}</pre>
        <div class="expand-overlay absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-muted via-muted/95 to-transparent flex items-end justify-center pb-2 hidden">
          <button class="expand-prompt-btn text-xs font-bold text-primary hover:text-accent transition-colors bg-muted/80 px-4 py-1 rounded-full border border-border/50 shadow-sm hover:shadow-md flex items-center gap-1 backdrop-blur-sm">
            <span>üëá</span>
            <span>–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Å—å –ø—Ä–æ–º—Ç</span>
          </button>
        </div>
      </div>
    </div>
    
    {finalImagePath ? (
      <div class="prompt-result">
        <p class="result-label mb-2 text-xs font-semibold">–†–µ–∑—É–ª—å—Ç–∞—Ç:</p>
        <img 
          src={finalImagePath} 
          alt={`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${title}`}
          loading="lazy"
          class="result-image"
          data-image-modal={finalImagePath}
        />
      </div>
    ) : (
      <div class="prompt-result-placeholder">
        <p class="placeholder-text text-sm">üñºÔ∏è –ú–µ—Å—Ç–æ –¥–ª—è —Ñ–æ—Ç–æ</p>
        <p class="placeholder-hint text-xs">
          <code>prompt-{number}.jpg</code>
        </p>
      </div>
    )}
  </div>
</div>

<script is:inline>
  (function() {
    let initialized = false;
    
    function initCopyButtons() {
      document.querySelectorAll('.copy-button').forEach(button => {
        if (!(button instanceof HTMLElement)) return;
        if (button.dataset.initialized) return;
        button.dataset.initialized = 'true';
        
        button.addEventListener('click', async (e) => {
          e.preventDefault();
          const promptText = button.getAttribute('data-prompt');
          if (promptText) {
            try {
              await navigator.clipboard.writeText(promptText);
              const originalText = button.textContent;
              button.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
              button.classList.add('copied');
              
              setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('copied');
              }, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
              button.textContent = '‚úó –û—à–∏–±–∫–∞';
              setTimeout(() => {
                button.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
              }, 2000);
            }
          }
        });
      });
    }

    function initImageModal() {
      document.querySelectorAll('[data-image-modal]').forEach(img => {
        if (!(img instanceof HTMLElement)) return;
        if (img.dataset.modalInitialized) return;
        img.dataset.modalInitialized = 'true';
        
        img.style.cursor = 'pointer';
        img.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const imageSrc = img.getAttribute('data-image-modal');
          if (!imageSrc) return;
          
          console.log('Opening modal for image:', imageSrc);
          
          const modal = document.createElement('div');
          modal.className = 'image-modal';
          modal.style.position = 'fixed';
          modal.style.inset = '0';
          modal.style.zIndex = '9999';
          modal.style.display = 'flex';
          modal.style.alignItems = 'center';
          modal.style.justifyContent = 'center';
          
          const overlay = document.createElement('div');
          overlay.className = 'image-modal-overlay';
          overlay.style.position = 'absolute';
          overlay.style.inset = '0';
          overlay.style.background = 'rgba(0, 0, 0, 0.15)';
          overlay.style.backdropFilter = 'blur(12px)';
          overlay.style.webkitBackdropFilter = 'blur(12px)';
          overlay.style.cursor = 'pointer';
          
          const content = document.createElement('div');
          content.className = 'image-modal-content';
          content.style.position = 'relative';
          content.style.zIndex = '10000';
          content.style.cursor = 'default';
          content.style.display = 'inline-block';
          content.style.transition = 'transform 0.2s ease-out';
          content.style.transformOrigin = 'center center';
          content.style.animation = 'modalZoom 0.3s ease-out';
          
          const isMobile = window.innerWidth < 768;
          
          const closeBtn = document.createElement('button');
          closeBtn.className = 'image-modal-close';
          closeBtn.innerHTML = '‚úï';
          closeBtn.setAttribute('aria-label', '–ó–∞–∫—Ä—ã—Ç—å');
          closeBtn.style.position = 'absolute';
          closeBtn.style.top = '10px';
          closeBtn.style.right = '10px';
          closeBtn.style.background = 'rgba(0, 0, 0, 0.6)';
          closeBtn.style.border = 'none';
          closeBtn.style.color = 'white';
          closeBtn.style.width = '36px';
          closeBtn.style.height = '36px';
          closeBtn.style.borderRadius = '50%';
          closeBtn.style.cursor = 'pointer';
          closeBtn.style.fontSize = '1.25rem';
          closeBtn.style.lineHeight = '1';
          closeBtn.style.display = 'flex';
          closeBtn.style.alignItems = 'center';
          closeBtn.style.justifyContent = 'center';
          closeBtn.style.zIndex = '10001';
          closeBtn.style.backdropFilter = 'blur(10px)';
          closeBtn.style.webkitBackdropFilter = 'blur(10px)';
          closeBtn.style.transformOrigin = 'top right';
          closeBtn.style.transition = 'transform 0.2s ease-out, top 0.2s ease-out, right 0.2s ease-out';
          
          const zoomControls = document.createElement('div');
          zoomControls.className = 'image-modal-zoom-controls';
          zoomControls.style.position = 'absolute';
          zoomControls.style.bottom = '50px';
          zoomControls.style.left = '50%';
          zoomControls.style.transform = 'translateX(-50%)';
          zoomControls.style.display = 'flex';
          zoomControls.style.gap = '24px';
          zoomControls.style.zIndex = '10001';
          zoomControls.style.padding = '10px 20px';
          zoomControls.style.borderRadius = '50px';
          zoomControls.style.background = 'rgba(20, 20, 20, 0.4)';
          zoomControls.style.backdropFilter = 'blur(16px)';
          zoomControls.style.webkitBackdropFilter = 'blur(16px)';
          zoomControls.style.border = '1px solid rgba(255, 255, 255, 0.1)';
          zoomControls.style.boxShadow = '0 8px 32px 0 rgba(0, 0, 0, 0.2)';
          
          let currentZoom = 1;

          const createZoomBtn = (symbol, action) => {
              const btn = document.createElement('button');
              btn.innerHTML = symbol;
              btn.style.width = '44px';
              btn.style.height = '44px';
              btn.style.borderRadius = '50%';
              btn.style.background = 'rgba(255, 255, 255, 0.1)';
              btn.style.border = '1px solid rgba(255, 255, 255, 0.2)';
              btn.style.color = 'white';
              btn.style.fontSize = '1.5rem';
              btn.style.display = 'flex';
              btn.style.alignItems = 'center';
              btn.style.justifyContent = 'center';
              btn.style.cursor = 'pointer';
              btn.style.transition = 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)';
              btn.style.paddingBottom = symbol === '‚àí' ? '2px' : '0';
              
              btn.addEventListener('mouseenter', () => {
                btn.style.background = 'rgba(255, 255, 255, 0.25)';
                btn.style.transform = 'scale(1.1)';
                btn.style.boxShadow = '0 0 15px rgba(255, 255, 255, 0.2)';
              });
              
              btn.addEventListener('mouseleave', () => {
                btn.style.background = 'rgba(255, 255, 255, 0.1)';
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = 'none';
              });

              btn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  action();
              });

              return btn;
          };

          const updateZoom = () => {
              content.style.transform = `scale(${currentZoom})`;
              
              const inverseScale = 1 / currentZoom;
              closeBtn.style.transform = `scale(${inverseScale})`;
              
              const offset = 10 / currentZoom;
              closeBtn.style.top = `${offset}px`;
              closeBtn.style.right = `${offset}px`;
          };

          const zoomInBtn = createZoomBtn('+', () => {
              currentZoom += 0.25;
              if (currentZoom > 3) currentZoom = 3;
              updateZoom();
          });

          const zoomOutBtn = createZoomBtn('‚àí', () => {
              currentZoom -= 0.25;
              if (currentZoom < 0.5) currentZoom = 0.5;
              updateZoom();
          });

          zoomControls.appendChild(zoomOutBtn);
          zoomControls.appendChild(zoomInBtn);
          
          const modalImg = document.createElement('img');
          modalImg.src = imageSrc;
          modalImg.alt = '–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
          modalImg.style.display = 'block';
          modalImg.style.width = 'auto';
          modalImg.style.height = 'auto';
          modalImg.style.maxWidth = isMobile ? '90vw' : '70vw'; // Slightly increased for mobile
          modalImg.style.maxHeight = isMobile ? '75vh' : '75vh'; // Slightly increased for mobile
          modalImg.style.objectFit = 'contain';
          modalImg.style.borderRadius = isMobile ? '12px' : '16px';
          modalImg.style.boxShadow = '0 25px 50px -12px rgba(0, 0, 0, 0.5)';
          
          content.appendChild(closeBtn);
          content.appendChild(modalImg);
          
          modal.appendChild(overlay);
          modal.appendChild(content);
          modal.appendChild(zoomControls);
          
          document.body.appendChild(modal);
          document.body.style.overflow = 'hidden';
          
          setTimeout(() => {
            modal.style.opacity = '1';
          }, 10);
          
          const closeModal = () => {
            console.log('Closing modal');
            modal.style.opacity = '0';
            content.style.transform = 'scale(0.9)';
            setTimeout(() => {
              if (modal.parentNode) {
                document.body.removeChild(modal);
              }
              document.body.style.overflow = '';
            }, 250);
          };
          
          overlay.addEventListener('click', closeModal);
          
          closeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal();
          });
          
          closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(0, 0, 0, 0.8)';
            const inverseScale = 1 / currentZoom;
            closeBtn.style.transform = `scale(${inverseScale * 1.1})`;
          });
          
          closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'rgba(0, 0, 0, 0.6)';
            const inverseScale = 1 / currentZoom;
            closeBtn.style.transform = `scale(${inverseScale})`;
          });
          
          content.addEventListener('click', (e) => {
            e.stopPropagation();
          });
          
          const escHandler = (e) => {
            if (e.key === 'Escape') {
              closeModal();
              document.removeEventListener('keydown', escHandler);
            }
          };
          document.addEventListener('keydown', escHandler);
        });
      });
    }

    function initExpandablePrompts() {
      document.querySelectorAll('.prompt-text-container').forEach(container => {
        if (container.dataset.expandInitialized) return;
        container.dataset.expandInitialized = 'true';

        const pre = container.querySelector('pre');
        const overlay = container.querySelector('.expand-overlay');
        const btn = container.querySelector('.expand-prompt-btn');

        if (!pre || !overlay || !btn) return;

        // Check if content overflows
        const checkOverflow = () => {
             // 180px is the max-height set in style
             const isOverflowing = pre.scrollHeight > 180;
             if (isOverflowing) {
                 overlay.classList.remove('hidden');
             } else {
                 overlay.classList.add('hidden');
             }
        };
        
        // Check immediately and after a short delay
        checkOverflow();
        setTimeout(checkOverflow, 100);

        btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const isExpanded = pre.style.maxHeight === 'none';
            const btnTextSpan = btn.querySelector('span:last-child');
            const btnIconSpan = btn.querySelector('span:first-child');
            
            if (isExpanded) {
                // Collapse
                pre.style.maxHeight = '180px';
                overlay.classList.remove('items-start', 'pt-4', 'bg-transparent', 'h-auto', 'static');
                overlay.classList.add('absolute', 'bottom-0', 'h-24', 'bg-gradient-to-t', 'from-muted', 'via-muted/95', 'to-transparent', 'items-end', 'pb-2');
                
                if (btnTextSpan) btnTextSpan.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Å—å –ø—Ä–æ–º—Ç';
                if (btnIconSpan) btnIconSpan.textContent = 'üëá';
                
                // Scroll back to top of card if needed? Maybe not strictly required but nice.
            } else {
                // Expand
                pre.style.maxHeight = 'none';
                // Remove gradient overlay styles but keep button visible at the bottom
                overlay.classList.remove('absolute', 'bottom-0', 'h-24', 'bg-gradient-to-t', 'from-muted', 'via-muted/95', 'to-transparent', 'items-end', 'pb-2');
                overlay.classList.add('static', 'h-auto', 'bg-transparent', 'items-start', 'pt-4');
                
                if (btnTextSpan) btnTextSpan.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
                if (btnIconSpan) btnIconSpan.textContent = '‚òùÔ∏è';
            }
        });
      });
    }

    function init() {
      if (initialized) return;
      initialized = true;
      initCopyButtons();
      initImageModal();
      initExpandablePrompts();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

<style>
  .prompt-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  
  .prompt-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .prompt-card:hover {
    border-color: var(--accent);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
  }
  
  .prompt-card:hover::before {
    opacity: 1;
  }
  
  [data-theme="dark"] .prompt-card {
    background: rgba(20, 20, 20, 0.7);
    backdrop-filter: blur(10px);
  }
  
  [data-theme="dark"] .prompt-card:hover {
    box-shadow: 0 8px 30px rgba(0, 212, 255, 0.2),
                0 0 40px rgba(0, 212, 255, 0.1);
    border-color: var(--neon-blue);
  }
  
  .prompt-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }
  
  .prompt-number {
    background: var(--primary);
    color: var(--primary-foreground);
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.8rem;
  }
  
  .prompt-title {
    flex: 1;
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    min-width: 200px;
  }
  
  .copy-button {
    background: transparent;
    border: 1px solid var(--border);
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 0.8rem;
    white-space: nowrap;
    font-weight: 500;
  }
  
  .copy-button:hover {
    background: var(--accent);
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  [data-theme="dark"] .copy-button:hover {
    box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3),
                0 0 20px rgba(0, 212, 255, 0.2);
    background: rgba(0, 212, 255, 0.1);
    border-color: var(--neon-blue);
    color: var(--neon-blue);
  }
  
  .copy-button.copied {
    background: #10b981;
    border-color: #10b981;
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  
  .prompt-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  @media (min-width: 768px) {
    .prompt-layout {
      grid-template-columns: 1fr 280px;
      gap: 1.5rem;
    }
  }
  
  .prompt-content {
    background: var(--muted);
    border-radius: 8px;
    padding: 0.875rem;
    overflow-x: auto;
    border: 1px solid var(--border);
  }
  
  [data-theme="dark"] .prompt-content {
    background: rgba(20, 20, 20, 0.8);
    border-color: rgba(255, 255, 255, 0.1);
  }
  
  .prompt-content pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    line-height: 1.5;
    color: var(--foreground);
  }
  
  [data-theme="dark"] .prompt-content pre {
    color: rgba(250, 250, 250, 0.95);
  }
  
  .prompt-result {
    display: flex;
    flex-direction: column;
  }
  
  .result-image {
    width: 100%;
    border-radius: 8px;
    margin-top: 0.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .result-image:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }
  
  .prompt-result-placeholder {
    background: var(--muted);
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 1.5rem 1rem;
    text-align: center;
  }
  
  .placeholder-text {
    margin-bottom: 0.5rem;
  }
  
  .placeholder-hint {
    color: var(--muted-foreground);
    word-break: break-all;
  }
  
  .placeholder-hint code {
    background: var(--background);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 0.7rem;
  }
  
  /* Image Modal Styles */
  .image-modal {
    opacity: 0;
    transition: opacity 0.25s ease;
  }
  
  @keyframes modalZoom {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  .image-modal-content {
    transition: transform 0.25s ease;
  }
</style>
